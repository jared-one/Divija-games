<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>DIVIJA: SYSTEM REBOOT</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@1,600&family=VT323&display=swap');
    :root{--bg:#050505;--heart:#ff3e3e;--soul:#00f3ff;--gold:#ffd700}
    body{margin:0;background:#000;height:100vh;width:100vw;display:flex;justify-content:center;align-items:center;font-family:'VT323',monospace;overflow:hidden;user-select:none;-webkit-user-select:none;color:#fff}
    #crt-frame{position:relative;width:100%;height:100%;max-width:900px;max-height:650px;background:#000;border:2px solid #222;box-shadow:0 0 50px rgba(0,243,255,.15);overflow:hidden}
    canvas{display:block;width:100%;height:100%;image-rendering:pixelated}
    .scanlines{position:absolute;top:0;left:0;width:100%;height:100%;
      background:linear-gradient(rgba(18,16,16,0) 50%,rgba(0,0,0,.25) 50%),
               linear-gradient(90deg,rgba(255,0,0,.06),rgba(0,255,0,.02),rgba(0,0,255,.06));
      background-size:100% 3px,3px 100%;pointer-events:none;z-index:10}
    .ui-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:20;padding:20px;box-sizing:border-box;display:flex;flex-direction:column;justify-content:space-between}
    #hud{opacity:0;transition:opacity 1s}
    .bar-container{display:flex;align-items:center;margin-bottom:8px}
    .bar-label{width:40px;color:var(--gold);font-size:20px}
    .bar-border{width:150px;height:12px;border:2px solid #fff;background:#222;margin-left:10px}
    .bar-fill{height:100%;transition:width .1s linear}

    #dialogue-box{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:90%;min-height:160px;background:rgba(0,0,0,.95);border:2px solid #fff;padding:15px;display:none;box-sizing:border-box;pointer-events:auto}
    .portrait{width:100px;height:100px;border:1px solid #444;float:left;margin-right:15px;background:#111;display:flex;justify-content:center;align-items:center}
    .text-content{margin-left:120px;font-family:'Cormorant Garamond',serif;font-size:26px;line-height:1.2;white-space:pre-wrap;color:#ddd}
    .speaker{color:var(--soul);font-family:'VT323';font-size:22px;margin-bottom:5px;text-transform:uppercase;letter-spacing:2px}
    .next-btn{position:absolute;bottom:10px;right:15px;font-family:'VT323';color:var(--gold);animation:blink 1s infinite;font-size:18px}

    .fullscreen-text{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#000;z-index:50;transition:opacity 1s;pointer-events:auto}
    .hidden{opacity:0;pointer-events:none}
    h1{font-size:80px;color:var(--soul);margin:0;text-shadow:0 0 20px var(--soul);letter-spacing:5px}
    button{margin-top:20px;background:transparent;color:#fff;border:2px solid #fff;font-family:'VT323';font-size:28px;padding:15px 50px;cursor:pointer;transition:.2s}
    button:hover{background:#fff;color:#000;box-shadow:0 0 20px #fff}

    #touch-controls{display:none;position:absolute;bottom:0;left:0;width:100%;height:100%;pointer-events:none;z-index:100}
    .dpad-container{position:absolute;bottom:40px;left:40px;width:160px;height:160px;pointer-events:none}
    .dpad-btn{position:absolute;background:rgba(255,255,255,.15);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.3);pointer-events:auto;border-radius:8px}
    .dpad-btn:active{background:rgba(255,255,255,.5)}
    #btn-up{top:0;left:50px;width:60px;height:60px}
    #btn-down{bottom:0;left:50px;width:60px;height:60px}
    #btn-left{top:50px;left:0;width:60px;height:60px}
    #btn-right{top:50px;right:0;width:60px;height:60px}
    .action-btn{position:absolute;width:80px;height:80px;border-radius:50%;backdrop-filter:blur(4px);border:2px solid rgba(255,255,255,.5);pointer-events:auto;display:flex;justify-content:center;align-items:center;font-size:24px;color:rgba(255,255,255,.8)}
    .action-btn:active{background:#fff;color:#000}
    #btn-z{bottom:40px;right:40px;background:rgba(255,62,62,.2)}
    #btn-x{bottom:60px;right:140px;background:rgba(0,243,255,.2);width:60px;height:60px;font-size:20px}

    @media (max-width:900px){
      #touch-controls{display:block}
      #crt-frame{width:100vw;height:100vh;max-width:none;max-height:none;border:none}
      h1{font-size:50px}
      #dialogue-box{bottom:40%}
    }
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
  </style>
</head>
<body>
  <div id="crt-frame">
    <canvas id="canvas" aria-label="game canvas"></canvas>
    <div class="scanlines"></div>

    <div id="touch-controls">
      <div class="dpad-container">
        <div id="btn-up" class="dpad-btn"></div>
        <div id="btn-down" class="dpad-btn"></div>
        <div id="btn-left" class="dpad-btn"></div>
        <div id="btn-right" class="dpad-btn"></div>
      </div>
      <div id="btn-z" class="action-btn">Z</div>
      <div id="btn-x" class="action-btn">X</div>
    </div>

    <div class="ui-layer">
      <div id="hud">
        <div class="bar-container">
          <span class="bar-label">HP</span>
          <div class="bar-border"><div class="bar-fill" id="hp-bar" style="background:var(--heart);width:100%"></div></div>
        </div>
        <div class="bar-container">
          <span class="bar-label">MP</span>
          <div class="bar-border"><div class="bar-fill" id="mp-bar" style="background:var(--soul);width:0%"></div></div>
        </div>
      </div>

      <div id="dialogue-box">
        <div class="portrait"><canvas id="p-canvas" width="100" height="100"></canvas></div>
        <div class="text-content">
          <div class="speaker" id="speaker-name">UNKNOWN</div>
          <div id="dialogue-text"></div>
        </div>
        <div class="next-btn">[Z] CONTINUE</div>
      </div>
    </div>

    <div id="intro-screen" class="fullscreen-text">
      <h1>DIVIJA</h1>
      <p style="color:#888;font-size:24px;letter-spacing:5px;margin:12px 0 30px;font-family:'Cormorant Garamond';font-style:italic;">
        The Calculus of the Heart
      </p>
      <button id="start-btn">INITIALIZE</button>
      <button id="fs-btn" style="font-size:22px;padding:10px 28px;margin-top:14px;">FULLSCREEN</button>
      <div style="margin-top:22px;font-size:16px;color:#555;font-family:'VT323';text-align:center;">
        KEYBOARD: Arrows/WASD • Z/Enter Interact • X/Shift Bomb (needs MP)<br/>
        TOUCH: On-screen controls enabled
      </div>
    </div>

    <div id="game-over" class="fullscreen-text hidden">
      <h1 style="color:#666;font-size:60px">FATAL ERROR</h1>
      <p style="font-size:24px;color:#aaa;">The heart stopped, but the memory remains.</p>
      <button id="retry-btn">REBOOT SYSTEM</button>
    </div>

    <div id="victory-screen" class="fullscreen-text hidden">
      <h1 style="color:var(--gold)">PROOF COMPLETE</h1>
      <div style="text-align:center;max-width:600px;font-family:'Cormorant Garamond';font-size:26px;line-height:1.5;">
        <p>You have compiled the fragments of your soul.</p>
        <p>You are whole.</p>
        <hr style="border-color:#333;margin:20px 0;">
        <p style="color:var(--heart);font-size:32px;text-shadow:0 0 10px var(--heart);">Happy Birthday, Divija.</p>
        <p style="color:#888;font-size:20px;margin-top:10px;">- Daddy</p>
      </div>
      <button onclick="location.reload()">SLEEP</button>
    </div>
  </div>

<script>
const FRAME = document.getElementById('crt-frame');
const CANVAS = document.getElementById('canvas');
const CTX = CANVAS.getContext('2d');
const P_CTX = document.getElementById('p-canvas').getContext('2d');

let W = 900, H = 650, DPR = 1;
let resizeQueued = false;

function resizeNow(){
  const w = FRAME.clientWidth;
  const h = FRAME.clientHeight;
  if (!w || !h) return;                 // fullscreen can transiently report 0
  DPR = Math.min(2, window.devicePixelRatio || 1);
  W = w; H = h;
  CANVAS.width = Math.floor(w * DPR);
  CANVAS.height = Math.floor(h * DPR);
  CTX.setTransform(DPR,0,0,DPR,0,0);    // draw in CSS pixels
  // Keep entities in-bounds on resize
  Game.player.x = Math.max(20, Math.min(W-20, Game.player.x));
  Game.player.y = Math.max(20, Math.min(H-20, Game.player.y));
  Game.boss.x = W/2;
}
function queueResize(){
  if(resizeQueued) return;
  resizeQueued = true;
  requestAnimationFrame(() => { resizeQueued = false; resizeNow(); });
}
new ResizeObserver(queueResize).observe(FRAME);
window.addEventListener('resize', queueResize);
document.addEventListener('fullscreenchange', () => { queueResize(); setTimeout(queueResize, 50); });
queueResize();

// --- Fullscreen helper (robust across browsers) ---
async function toggleFullscreen(){
  try{
    if(!document.fullscreenElement){
      await (FRAME.requestFullscreen ? FRAME.requestFullscreen() : document.documentElement.requestFullscreen());
    } else {
      await document.exitFullscreen();
    }
  }catch(e){ /* ignore */ }
  queueResize();
}

// --- INPUT ---
const Input = {
  keys:{},
  pressed:{ fire:false, bomb:false },
  touch:{ up:false,down:false,left:false,right:false,z:false,x:false },
  init(){
    const prevent = new Set(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space']);
    const onKeyDown = (e)=>{
      if(prevent.has(e.code)) e.preventDefault();
      const was = !!this.keys[e.code];
      this.keys[e.code]=true;
      if(!was){
        if(e.code==='KeyZ'||e.code==='Enter') this.pressed.fire=true;
        if(e.code==='KeyX'||e.code==='ShiftLeft') this.pressed.bomb=true;
      }
      // convenience: F for fullscreen
      if(!was && e.code==='KeyF') toggleFullscreen();
    };
    const onKeyUp = (e)=>{ this.keys[e.code]=false; };
    window.addEventListener('keydown', onKeyDown, {passive:false});
    window.addEventListener('keyup', onKeyUp);

    const bind=(id,key,onPress)=>{
      const el=document.getElementById(id); if(!el) return;
      el.addEventListener('touchstart',(e)=>{e.preventDefault();this.touch[key]=true;onPress&&onPress();},{passive:false});
      el.addEventListener('touchend',(e)=>{e.preventDefault();this.touch[key]=false;},{passive:false});
    };
    bind('btn-up','up'); bind('btn-down','down'); bind('btn-left','left'); bind('btn-right','right');
    bind('btn-z','z',()=>this.pressed.fire=true);
    bind('btn-x','x',()=>this.pressed.bomb=true);

    // tap anywhere: advance dialogue / skip intro
    FRAME.addEventListener('pointerdown', ()=>{
      if(Game.state==='INTRO' || Game.state==='DIALOGUE') this.pressed.fire=true;
    });
  },
  consume(a){ if(!this.pressed[a]) return false; this.pressed[a]=false; return true; },
  isDown(a){
    if(a==='up') return this.keys['ArrowUp']||this.keys['KeyW']||this.touch.up;
    if(a==='down') return this.keys['ArrowDown']||this.keys['KeyS']||this.touch.down;
    if(a==='left') return this.keys['ArrowLeft']||this.keys['KeyA']||this.touch.left;
    if(a==='right') return this.keys['ArrowRight']||this.keys['KeyD']||this.touch.right;
    if(a==='fire') return this.keys['KeyZ']||this.keys['Enter']||this.touch.z;
    if(a==='bomb') return this.keys['KeyX']||this.keys['ShiftLeft']||this.touch.x;
    return false;
  }
};

// --- AUDIO ---
const AudioMan = {
  ctx:null,
  music:{ on:false, timer:null },
  init(){
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    if(!this.ctx) this.ctx = new AudioContext();
  },
  ensure(){ if(this.ctx && this.ctx.state==='suspended') this.ctx.resume().catch(()=>{}); },
  play(freq,type,dur,vol=0.1){
    if(!this.ctx) return;
    this.ensure();
    const t=this.ctx.currentTime;
    const o=this.ctx.createOscillator();
    const g=this.ctx.createGain();
    o.type=type; o.frequency.setValueAtTime(freq,t);
    g.gain.setValueAtTime(vol,t);
    g.gain.exponentialRampToValueAtTime(0.001,t+dur);
    o.connect(g); g.connect(this.ctx.destination);
    o.start(t); o.stop(t+dur);
  },
  sfx(id){
    if(id==='text') this.play(760+Math.random()*220,'sine',0.05,0.02);
    if(id==='shoot') this.play(320,'triangle',0.08,0.05);
    if(id==='hit') this.play(95,'sawtooth',0.25,0.2);
    if(id==='graze') this.play(1250,'sine',0.06,0.03);
    if(id==='bomb') { this.play(60,'sawtooth',0.35,0.18); this.play(240,'triangle',0.25,0.08); }
  },
  // Sad intro pad (procedural, original)
  startSadIntro(){
    this.init(); this.ensure();
    if(this.music.on) return;
    this.music.on = true;
    const chordSets = [
      [220.00, 261.63, 329.63],  // A3 C4 E4 (minor color)
      [196.00, 246.94, 293.66],  // G3 B3 D4
      [174.61, 220.00, 261.63],  // F3 A3 C4
      [185.00, 233.08, 277.18]   // F#3 A#3 C#4 (uneasy)
    ];
    let idx=0;
    const tick=()=>{
      if(!this.music.on || !this.ctx) return;
      this.ensure();
      const t=this.ctx.currentTime;
      const master=this.ctx.createGain();
      master.gain.setValueAtTime(0.06,t);
      master.connect(this.ctx.destination);

      // soft noise breath
      const noise=this.ctx.createBufferSource();
      const buf=this.ctx.createBuffer(1, this.ctx.sampleRate*1.2, this.ctx.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.08;
      noise.buffer=buf;
      const lp=this.ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.setValueAtTime(420,t);
      const ng=this.ctx.createGain();
      ng.gain.setValueAtTime(0.0001,t);
      ng.gain.exponentialRampToValueAtTime(0.25,t+0.15);
      ng.gain.exponentialRampToValueAtTime(0.0001,t+1.1);
      noise.connect(lp); lp.connect(ng); ng.connect(master);
      noise.start(t); noise.stop(t+1.2);

      // chord
      const chord=chordSets[idx%chordSets.length]; idx++;
      chord.forEach((f, j)=>{
        const o=this.ctx.createOscillator();
        const g=this.ctx.createGain();
        o.type='sine';
        o.frequency.setValueAtTime(f*(j===0?0.5:1),t);  // add sub
        g.gain.setValueAtTime(0.0001,t);
        g.gain.exponentialRampToValueAtTime(0.22,t+0.25);
        g.gain.exponentialRampToValueAtTime(0.0001,t+2.8);
        o.connect(g); g.connect(master);
        o.start(t); o.stop(t+3.0);
      });
    };
    tick();
    this.music.timer = setInterval(tick, 3000);
  },
  stopMusic(){
    this.music.on=false;
    if(this.music.timer) clearInterval(this.music.timer);
    this.music.timer=null;
  }
};

// --- CINEMATIC ---
const Cinematic = {
  phase:0, timer:0,
  start(){
    this.phase=0; this.timer=0;
    document.getElementById('intro-screen').classList.add('hidden');
  },
  update(){
    this.timer++;
    if(Input.consume('fire')) { Game.startScript(); return; }
    if(this.phase===0){ if(this.timer>120){ this.phase=1; this.timer=0; } }
    else if(this.phase===1){ if(this.timer>160){ this.phase=2; this.timer=0; } }
    else if(this.phase===2){ if(this.timer>180){ Game.startScript(); } }
  },
  draw(ctx){
    ctx.fillStyle="#000"; ctx.fillRect(0,0,W,H);
    const cx=W/2, cy=H/2;
    if(this.phase===0){
      ctx.fillStyle="#0f0"; ctx.font="20px monospace";
      ctx.fillText("> SYSTEM CRITICAL",50,50);
      ctx.fillText("> REALITY.EXE NOT FOUND",50,80);
      ctx.fillStyle="#666"; ctx.fillText("> PRESS Z TO SKIP",50,110);
      if(Math.random()>0.9){ ctx.fillStyle="#fff"; ctx.fillRect(0,Math.random()*H,W,5); }
      const sx=(Math.random()-0.5)*5;
      ctx.fillStyle="#ff3e3e"; ctx.beginPath(); ctx.arc(cx+sx,cy,30,0,Math.PI*2); ctx.fill();
    } else if(this.phase===1){
      const r=this.timer*4;
      ctx.strokeStyle="#00f3ff"; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
      const scale=1-(this.timer/160);
      ctx.fillStyle="#ff3e3e"; ctx.beginPath(); ctx.arc(cx,cy,Math.max(2,30*scale),0,Math.PI*2); ctx.fill();
      ctx.fillStyle="#fff"; ctx.font="30px VT323"; ctx.textAlign="center";
      ctx.fillText("FALLING INTO THE CODE...",cx,cy+100);
    } else {
      ctx.fillStyle="rgba(0,243,255,0.3)"; ctx.font="20px monospace";
      for(let i=0;i<30;i++) ctx.fillText(Math.random()>0.5?"1":"0",Math.random()*W,(this.timer*15+Math.random()*500)%H);
      const a=Math.min(1,this.timer/180);
      ctx.fillStyle=`rgba(255,255,255,${a})`; ctx.fillRect(0,0,W,H);
    }
  }
};

// --- GAME ---
const Game = {
  state:'MENU', tick:0, shake:0, flash:0,
  player:{ x:0,y:0,hp:20,maxHp:20,mp:0,maxMp:100,inv:0 },
  boss:{ active:false,x:0,y:0,hp:0,max:0,type:'echo' },
  bullets:[],
  lastGrazeTick:-9999,
  fightTick:0,

  // deeper story
  script:[
    {t:'text',s:'sys',txt:"BOOTING MEMORY SUBSYSTEM..."},
    {t:'text',s:'sys',txt:"CHECKSUM FAILED. Restoring from fragments..."},
    {t:'text',s:'divija',txt:"Hello...? My hands feel like static."},
    {t:'text',s:'divija',txt:"I was reading a message. Then the screen blinked—and I fell through it."},
    {t:'text',s:'sys',txt:"WARNING: Unauthorized Entity detected inside HEART_KERNEL."},
    {t:'text',s:'echo',txt:"You didn’t fall through a screen. You fell through yourself."},
    {t:'text',s:'divija',txt:"Who are you?"},
    {t:'text',s:'echo',txt:"The sentence you repeat when you’re tired: 'What if I’m not enough?'"},
    {t:'text',s:'echo',txt:"Prove me wrong."},
    {t:'combat',boss:'echo',hp:420},

    {t:'text',s:'divija',txt:"I’m still standing."},
    {t:'text',s:'echo',txt:"Good. Now meet the audience you never asked for."},
    {t:'text',s:'crowd',txt:"She’s trying again. Cute."},
    {t:'text',s:'crowd',txt:"Watch her panic when it gets hard."},
    {t:'text',s:'divija',txt:"I’m not a performance. I’m a person."},
    {t:'combat',boss:'crowd',hp:560},

    {t:'text',s:'sys',txt:"TEMPORAL INSTABILITY: Regret loop forming."},
    {t:'text',s:'clock',txt:"Tick. You remember. Tick. You replay. Tick. You blame."},
    {t:'text',s:'divija',txt:"Then I learn. And I move."},
    {t:'combat',boss:'clock',hp:720},

    {t:'text',s:'memory',txt:"Divija. Breathe with me."},
    {t:'text',s:'divija',txt:"Dad? Is that you?"},
    {t:'text',s:'memory',txt:"Always. You’re stronger than the noise—because you keep choosing to return."},
    {t:'text',s:'memory',txt:"Come home."},
    {t:'win'}
  ],
  sIdx:0,
  textTimer:null,currentStr:"",charPos:0,waiting:false,

  init(){ Input.init(); this.loop(); },

  hideAllScreens(){
    document.getElementById('intro-screen').classList.add('hidden');
    document.getElementById('game-over').classList.add('hidden');
    document.getElementById('victory-screen').classList.add('hidden');
  },

  startIntro(){
    AudioMan.startSadIntro();
    this.hideAllScreens();
    this.state='INTRO';
    document.getElementById('hud').style.opacity=0;
    document.getElementById('dialogue-box').style.display='none';
    document.getElementById('touch-controls').style.display='';
    Cinematic.start();
  },

  startScript(){
    this.hideAllScreens();
    this.state='DIALOGUE';
    this.tick=0; this.shake=0; this.flash=0;
    this.bullets=[]; this.boss.active=false;
    this.player.x=W/2; this.player.y=H-100;
    this.player.hp=this.player.maxHp; this.player.mp=0; this.player.inv=0;
    this.sIdx=0;
    document.getElementById('hud').style.opacity=1;
    document.getElementById('touch-controls').style.display='';
    this.processStep();
  },

  processStep(){
    if(this.sIdx>=this.script.length) return;
    const s=this.script[this.sIdx];
    if(s.t==='text'){ this.state='DIALOGUE'; this.showDialogue(s.s,s.txt); }
    else if(s.t==='combat'){
      this.state='COMBAT';
      document.getElementById('dialogue-box').style.display='none';
      clearInterval(this.textTimer); this.waiting=false;
      this.boss.active=true; this.boss.type=s.boss; this.boss.max=s.hp; this.boss.hp=s.hp;
      this.boss.x=W/2; this.boss.y=100;
      this.bullets=[]; this.fightTick=0;
    } else if(s.t==='win'){
      this.state='WIN';
      document.getElementById('victory-screen').classList.remove('hidden');
      document.getElementById('hud').style.opacity=0;
      document.getElementById('touch-controls').style.display='none';
      document.getElementById('dialogue-box').style.display='none';
    }
  },

  showDialogue(speaker,text){
    const box=document.getElementById('dialogue-box');
    box.style.display='block';
    document.getElementById('speaker-name').innerText=speaker;
    const txtEl=document.getElementById('dialogue-text');
    txtEl.textContent="";
    P_CTX.fillStyle="#111"; P_CTX.fillRect(0,0,100,100);
    this.drawPortrait(speaker);

    this.currentStr=text; this.charPos=0; this.waiting=false;
    clearInterval(this.textTimer);
    this.textTimer=setInterval(()=>{
      const ch=this.currentStr[this.charPos];
      txtEl.textContent += ch;
      this.charPos++;
      if(this.charPos%3===0) AudioMan.sfx('text');
      if(this.charPos>=this.currentStr.length){ clearInterval(this.textTimer); this.waiting=true; }
    },30);
  },

  handleInteraction(){
    if(this.state==='INTRO'){ this.startScript(); return; }
    if(this.state==='DIALOGUE'){
      if(!this.waiting){
        clearInterval(this.textTimer);
        document.getElementById('dialogue-text').textContent=this.currentStr;
        this.waiting=true;
      } else { this.sIdx++; this.processStep(); }
    }
  },

  drawPortrait(s){
    const ctx=P_CTX, cx=50, cy=50;
    if(s==='divija'){
      ctx.fillStyle="#ff3e3e"; ctx.beginPath(); ctx.arc(cx,cy,30,0,Math.PI*2); ctx.fill();
      ctx.fillStyle="#00f3ff"; ctx.beginPath(); ctx.arc(cx,cy,10,0,Math.PI*2); ctx.fill();
    } else if(s==='sys'){
      ctx.fillStyle="#00f3ff"; ctx.font="40px monospace"; ctx.textAlign="center"; ctx.fillText("SYS",cx,cy+10);
    } else if(s==='echo'){ ctx.fillStyle="#888"; ctx.fillRect(20,20,60,60); }
    else if(s==='crowd'){ ctx.fillStyle="#f0f"; for(let i=0;i<3;i++){ ctx.beginPath(); ctx.arc(30+i*20,50,10,0,Math.PI*2); ctx.fill(); } }
    else if(s==='clock'){
      ctx.strokeStyle="#ffd700"; ctx.lineWidth=3;
      ctx.beginPath(); ctx.arc(cx,cy,28,0,Math.PI*2); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx,cy-16); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+12,cy+6); ctx.stroke();
    } else { ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(cx,cy,20,0,Math.PI*2); ctx.fill(); }
  },

  bomb(){
    if(this.state!=='COMBAT') return;
    if(this.player.mp < 60) return;
    this.player.mp -= 60;
    AudioMan.sfx('bomb');
    this.shake = Math.max(this.shake, 14);
    this.flash = 18;
    // clear enemy bullets + chunk boss
    this.bullets = this.bullets.filter(b => b.t !== 'e');
    if(this.boss.active) this.boss.hp = Math.max(0, this.boss.hp - 30);
    if(this.boss.active && this.boss.hp===0){
      this.boss.active=false; this.bullets=[];
      this.sIdx++; this.processStep();
    }
  },

  spawnBossBullets(){
    const t=this.fightTick, bx=this.boss.x, by=this.boss.y;
    const hpPct = this.boss.hp / this.boss.max;

    // helper
    const push=(vx,vy,c,r=5)=>this.bullets.push({x:bx,y:by,vx,vy,ax:0,ay:0,t:'e',c,r});

    if(this.boss.type==='echo'){
      // aimed triples, then faster when low hp
      const rate = hpPct<0.45 ? 10 : 14;
      const spd  = hpPct<0.45 ? 6.0 : 5.0;
      if(t % rate === 0){
        const ang = Math.atan2(this.player.y - by, this.player.x - bx);
        for(let i=-1;i<=1;i++){
          const a = ang + i*0.16;
          push(Math.cos(a)*spd, Math.sin(a)*spd, '#fff', 5);
        }
      }
      // occasional "echo ring"
      if(hpPct<0.6 && t%90===0){
        for(let i=0;i<14;i++){
          const a=i*(Math.PI*2/14);
          push(Math.cos(a)*3.5, Math.sin(a)*3.5, '#aaa', 4);
        }
      }
    }

    if(this.boss.type==='crowd'){
      // radial pressure + targeted snipes (harder)
      const ringRate = hpPct<0.5 ? 22 : 28;
      if(t % ringRate === 0){
        const n = hpPct<0.5 ? 16 : 12;
        const base = t*0.05;
        const spd = hpPct<0.5 ? 4.2 : 3.6;
        for(let i=0;i<n;i++){
          const a = base + i*(Math.PI*2/n);
          push(Math.cos(a)*spd, Math.sin(a)*spd, '#f0f', 4);
        }
      }
      if(t % 18 === 0){
        const ang = Math.atan2(this.player.y - by, this.player.x - bx);
        const spd = hpPct<0.5 ? 6.2 : 5.6;
        const a = ang + Math.sin(t*0.12)*0.08;
        push(Math.cos(a)*spd, Math.sin(a)*spd, '#fff', 4);
      }
    }

    if(this.boss.type==='clock'){
      // spiral + periodic “clock hand” walls (this is your difficulty spike)
      const base = t * (hpPct<0.5 ? 0.10 : 0.075);
      if(t % (hpPct<0.5 ? 10 : 14) === 0){
        const arms = hpPct<0.5 ? 18 : 14;
        const spd = hpPct<0.5 ? 4.6 : 4.0;
        for(let i=0;i<arms;i++){
          const a = base + i*(Math.PI*2/arms);
          push(Math.cos(a)*spd, Math.sin(a)*spd, '#ffd700', 4);
        }
      }
      if(t % 120 === 0){
        // “hands”: two thick lines that force repositioning
        const ang = t*0.02;
        for(let k=0;k<22;k++){
          const d = 40 + k*18;
          this.bullets.push({x:bx+Math.cos(ang)*d,y:by+Math.sin(ang)*d,vx:0,vy:2.8,ax:0,ay:0,t:'e',c:'#ffd700',r:5});
          this.bullets.push({x:bx+Math.cos(ang+Math.PI)*d,y:by+Math.sin(ang+Math.PI)*d,vx:0,vy:2.8,ax:0,ay:0,t:'e',c:'#ffd700',r:5});
        }
      }
    }
  },

  loop(){
    requestAnimationFrame(()=>this.loop());
    this.tick++;

    if(Input.consume('fire')) this.handleInteraction();
    if(Input.consume('bomb')) this.bomb();

    CTX.fillStyle="#050505"; CTX.fillRect(0,0,W,H);

    // flash on bomb
    if(this.flash>0){
      this.flash--;
      CTX.fillStyle=`rgba(255,255,255,${this.flash/18*0.35})`;
      CTX.fillRect(0,0,W,H);
    }

    // shake (paired)
    let didShake=false;
    if(this.shake>0){
      CTX.save(); didShake=true;
      CTX.translate(Math.random()*this.shake-this.shake/2, Math.random()*this.shake-this.shake/2);
      this.shake*=0.9; if(this.shake<0.5) this.shake=0;
    }

    if(this.state==='INTRO'){ Cinematic.update(); Cinematic.draw(CTX); if(didShake) CTX.restore(); return; }

    if(this.state==='DIALOGUE' || this.state==='COMBAT'){
      // movement
      const focus = Input.isDown('bomb'); // hold Shift/X for precision (still works)
      const spd = focus ? 3 : 6;
      if(this.state==='COMBAT'){
        if(Input.isDown('left')) this.player.x-=spd;
        if(Input.isDown('right')) this.player.x+=spd;
        if(Input.isDown('up')) this.player.y-=spd;
        if(Input.isDown('down')) this.player.y+=spd;
        this.player.x=Math.max(20,Math.min(W-20,this.player.x));
        this.player.y=Math.max(20,Math.min(H-20,this.player.y));

        // shoot
        if(Input.isDown('fire') && this.tick%5===0){
          this.bullets.push({x:this.player.x,y:this.player.y,vx:0,vy:-15,ax:0,ay:0,t:'p',c:'#ff3e3e',r:4});
          AudioMan.sfx('shoot');
        }
      }

      // player draw
      if(this.player.inv>0) this.player.inv--;
      if(!(this.player.inv>0 && Math.floor(this.tick/4)%2)){
        const x=this.player.x,y=this.player.y;
        CTX.fillStyle="#ff3e3e";
        CTX.beginPath();
        CTX.moveTo(x,y+5);
        CTX.bezierCurveTo(x,y,x-10,y-10,x-10,y);
        CTX.bezierCurveTo(x-10,y+10,x,y+15,x,y+20);
        CTX.bezierCurveTo(x,y+15,x+10,y+10,x+10,y);
        CTX.bezierCurveTo(x+10,y-10,x,y,x,y+5);
        CTX.fill();
        if(focus){
          CTX.fillStyle="#00f3ff";
          CTX.beginPath(); CTX.arc(x,y+8,4,0,Math.PI*2); CTX.fill();
        }
      }

      // boss
      if(this.state==='COMBAT' && this.boss.active){
        this.fightTick++;
        this.boss.x = W/2 + Math.sin(this.fightTick*0.02)*110;
        CTX.fillStyle = this.boss.type==='echo' ? '#aaa' : (this.boss.type==='crowd' ? '#f0f' : '#ffd700');
        CTX.fillRect(this.boss.x-30,this.boss.y-30,60,60);
        this.spawnBossBullets();
      }

      // bullets
      for(let i=this.bullets.length-1;i>=0;i--){
        const b=this.bullets[i];
        b.vx += b.ax || 0; b.vy += b.ay || 0;
        b.x += b.vx; b.y += b.vy;

        CTX.fillStyle=b.c;
        CTX.beginPath(); CTX.arc(b.x,b.y,b.r||5,0,Math.PI*2); CTX.fill();

        if(b.x<-30||b.x>W+30||b.y<-30||b.y>H+30){ this.bullets.splice(i,1); continue; }

        if(b.t==='e'){
          const hitX=this.player.x, hitY=this.player.y+10;
          const d=Math.hypot(b.x-hitX,b.y-hitY);

          if(d < (b.r||5)+5 && this.player.inv===0){
            this.player.hp--;
            this.player.inv=60;
            this.shake=Math.max(this.shake,10);
            AudioMan.sfx('hit');
            this.bullets.splice(i,1);
            if(this.player.hp<=0){
              this.state='OVER';
              document.getElementById('game-over').classList.remove('hidden');
              document.getElementById('touch-controls').style.display='none';
              document.getElementById('dialogue-box').style.display='none';
            }
          } else if(d < 28){
            if(this.tick - this.lastGrazeTick > 10){
              this.lastGrazeTick=this.tick;
              this.player.mp = Math.min(this.player.maxMp, this.player.mp + 2);
              AudioMan.sfx('graze');
            }
          }
        } else if(b.t==='p' && this.boss.active){
          const d=Math.hypot(b.x-this.boss.x,b.y-this.boss.y);
          if(d<40){
            this.boss.hp--;
            this.player.mp = Math.min(this.player.maxMp, this.player.mp + 1);
            this.bullets.splice(i,1);
            if(this.boss.hp<=0){
              this.boss.active=false; this.bullets=[];
              this.sIdx++; this.processStep();
            }
          }
        }
      }

      // HUD
      document.getElementById('hp-bar').style.width=((this.player.hp/this.player.maxHp)*100)+"%";
      document.getElementById('mp-bar').style.width=((this.player.mp/this.player.maxMp)*100)+"%";
    }

    if(didShake) CTX.restore();
  }
};

Game.init();

// UI bindings
document.getElementById('start-btn').onclick = () => { AudioMan.init(); Game.startIntro(); };
document.getElementById('retry-btn').onclick = () => Game.startScript();
document.getElementById('fs-btn').onclick = () => { AudioMan.init(); toggleFullscreen(); };

// Don’t let audio keep “burning” when tab is hidden
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden) AudioMan.stopMusic();
});
</script>
</body>
</html>
