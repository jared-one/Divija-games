<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>DIVIJA: SYSTEM REBOOT</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@1,600&family=VT323&display=swap');

:root{--bg:#050505;--heart:#ff3e3e;--soul:#00f3ff;--gold:#ffd700;}
body{margin:0;background:#000;height:100vh;width:100vw;display:flex;justify-content:center;align-items:center;font-family:'VT323',monospace;overflow:hidden;user-select:none;-webkit-user-select:none;color:#fff;}
#crt-frame{position:relative;width:100%;height:100%;max-width:900px;max-height:650px;background:#000;border:2px solid #222;box-shadow:0 0 50px rgba(0,243,255,.15);overflow:hidden;}
canvas{display:block;width:100%;height:100%;image-rendering:pixelated;}
.scanlines{position:absolute;inset:0;background:linear-gradient(rgba(18,16,16,0) 50%,rgba(0,0,0,.25) 50%),linear-gradient(90deg,rgba(255,0,0,.06),rgba(0,255,0,.02),rgba(0,0,255,.06));background-size:100% 3px,3px 100%;pointer-events:none;z-index:10;}
.ui-layer{position:absolute;inset:0;pointer-events:none;z-index:20;padding:16px;box-sizing:border-box;display:flex;flex-direction:column;justify-content:space-between;}

#hud{opacity:0;transition:opacity 1s;}
.bar-container{display:flex;align-items:center;margin-bottom:8px;}
.bar-label{width:40px;color:var(--gold);font-size:20px;}
.bar-border{width:150px;height:12px;border:2px solid #fff;background:#222;margin-left:10px;}
.bar-fill{height:100%;transition:width .1s linear;}
#boss-bar-container{display:none;margin-top:8px;}
#boss-name{color:var(--soul);font-size:18px;letter-spacing:2px;text-transform:uppercase;}
#boss-bar-border{width:250px;max-width:60vw;height:10px;border:2px solid #fff;background:#111;margin-top:6px;}
#boss-bar-fill{height:100%;background:linear-gradient(90deg,var(--soul),var(--heart));transition:width .2s;}

#dialogue-box{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:90%;min-height:160px;background:rgba(0,0,0,.95);border:2px solid #fff;padding:15px;display:none;box-sizing:border-box;pointer-events:auto;}
.portrait{width:100px;height:100px;border:1px solid #444;float:left;margin-right:15px;background:#111;display:flex;justify-content:center;align-items:center;}
.text-content{margin-left:120px;font-family:'Cormorant Garamond',serif;font-size:26px;line-height:1.2;white-space:pre-wrap;color:#ddd;}
.speaker{color:var(--soul);font-family:'VT323';font-size:22px;margin-bottom:5px;text-transform:uppercase;letter-spacing:2px;}
.next-btn{position:absolute;bottom:10px;right:15px;font-family:'VT323';color:var(--gold);animation:blink 1s infinite;font-size:18px;}

.fullscreen-text{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#000;z-index:50;transition:opacity 1s;pointer-events:auto;}
.hidden{opacity:0;pointer-events:none;}
h1{font-size:80px;color:var(--soul);margin:0;text-shadow:0 0 20px var(--soul);letter-spacing:5px;}
button{margin-top:40px;background:transparent;color:#fff;border:2px solid #fff;font-family:'VT323';font-size:28px;padding:15px 50px;cursor:pointer;transition:.2s;}
button:hover{background:#fff;color:#000;box-shadow:0 0 20px #fff;}

#touch-controls{display:none;position:absolute;inset:0;pointer-events:none;z-index:100;}
.dpad-container{position:absolute;bottom:40px;left:40px;width:160px;height:160px;pointer-events:none;}
.dpad-btn{position:absolute;background:rgba(255,255,255,.15);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.3);pointer-events:auto;border-radius:8px;touch-action:none;}
.dpad-btn:active{background:rgba(255,255,255,.5);}
#btn-up{top:0;left:50px;width:60px;height:60px;}
#btn-down{bottom:0;left:50px;width:60px;height:60px;}
#btn-left{top:50px;left:0;width:60px;height:60px;}
#btn-right{top:50px;right:0;width:60px;height:60px;}
.action-btn{position:absolute;width:80px;height:80px;border-radius:50%;backdrop-filter:blur(4px);border:2px solid rgba(255,255,255,.5);pointer-events:auto;display:flex;justify-content:center;align-items:center;font-size:24px;color:rgba(255,255,255,.8);touch-action:none;}
.action-btn:active{background:#fff;color:#000;}
#btn-z{bottom:40px;right:40px;background:rgba(255,62,62,.2);}
#btn-x{bottom:60px;right:140px;background:rgba(0,243,255,.2);width:60px;height:60px;font-size:20px;}

#control-help{
  position:absolute; top:16px; right:16px; z-index:30;
  background:rgba(0,0,0,.72); border:1px solid rgba(255,255,255,.25);
  padding:10px 12px; pointer-events:none; opacity:0; transition:opacity .25s;
  font-size:18px; line-height:1.25; min-width:200px;
}
#control-help strong{color:var(--gold); letter-spacing:2px;}
#control-help .hot{color:var(--soul);}
#control-help.show{opacity:1;}

@media (max-width: 900px){
  #touch-controls{display:block;}
  #crt-frame{width:100vw;height:100vh;max-width:none;max-height:none;border:none;}
  h1{font-size:50px;}
  #dialogue-box{bottom:40%;}
}

@keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}
</style>
</head>

<body>
<div id="crt-frame">
  <canvas id="canvas"></canvas>
  <div class="scanlines"></div>

  <div id="control-help">
    <strong>COMBAT</strong><br/>
    <span class="hot">ARROWS / WASD</span> Move<br/>
    <span class="hot">Z / ENTER</span> Shoot / Continue<br/>
    <span class="hot">X / SHIFT</span> Focus (slow)<br/>
    <span style="color:#aaa">Tip:</span> grazing builds MP
  </div>

  <div id="touch-controls">
    <div class="dpad-container">
      <div id="btn-up" class="dpad-btn"></div>
      <div id="btn-down" class="dpad-btn"></div>
      <div id="btn-left" class="dpad-btn"></div>
      <div id="btn-right" class="dpad-btn"></div>
    </div>
    <div id="btn-z" class="action-btn">Z</div>
    <div id="btn-x" class="action-btn">X</div>
  </div>

  <div class="ui-layer">
    <div id="hud">
      <div class="bar-container">
        <span class="bar-label">HP</span>
        <div class="bar-border"><div class="bar-fill" id="hp-bar" style="background:var(--heart);width:100%"></div></div>
      </div>
      <div class="bar-container">
        <span class="bar-label">MP</span>
        <div class="bar-border"><div class="bar-fill" id="mp-bar" style="background:var(--soul);width:0%"></div></div>
      </div>

      <div id="boss-bar-container">
        <div id="boss-name">BOSS</div>
        <div id="boss-bar-border"><div id="boss-bar-fill" style="width:100%"></div></div>
      </div>
    </div>

    <div id="dialogue-box">
      <div class="portrait"><canvas id="p-canvas" width="100" height="100"></canvas></div>
      <div class="text-content">
        <div class="speaker" id="speaker-name">UNKNOWN</div>
        <div id="dialogue-text"></div>
      </div>
      <div class="next-btn">[Z] CONTINUE</div>
    </div>
  </div>

  <div id="intro-screen" class="fullscreen-text">
    <h1>DIVIJA</h1>
    <p style="color:#888;font-size:24px;letter-spacing:5px;margin-bottom:40px;font-family:'Cormorant Garamond';font-style:italic;">
      The Calculus of the Heart
    </p>
    <button id="start-btn">INITIALIZE</button>
    <div style="margin-top:30px;font-size:16px;color:#555;font-family:'VT323';text-align:center;">
      KEYBOARD: Arrows/WASD • Z/Enter Interact/Shoot • X/Shift Focus<br>
      TOUCH: On-screen controls enabled
    </div>
  </div>

  <div id="game-over" class="fullscreen-text hidden">
    <h1 style="color:#666;font-size:60px">FATAL ERROR</h1>
    <p style="font-size:24px;color:#aaa;">The heart stopped, but the memory remains.</p>
    <button id="retry-btn">REBOOT SYSTEM</button>
  </div>

  <div id="victory-screen" class="fullscreen-text hidden">
    <h1 style="color:var(--gold)">PROOF COMPLETE</h1>
    <div style="text-align:center;max-width:600px;font-family:'Cormorant Garamond';font-size:26px;line-height:1.5;">
      <p>You have compiled the fragments of your soul.</p>
      <p>You are whole.</p>
      <hr style="border-color:#333;margin:20px 0;">
      <p style="color:var(--heart);font-size:32px;text-shadow:0 0 10px var(--heart);">Happy Birthday, Divija.</p>
      <p style="color:#888;font-size:20px;margin-top:10px;">- Daddy</p>
    </div>
    <button onclick="location.reload()">SLEEP</button>
  </div>
</div>

<script>
const CANVAS = document.getElementById('canvas');
const CTX = CANVAS.getContext('2d');
const P_CTX = document.getElementById('p-canvas').getContext('2d');
const FRAME = document.getElementById('crt-frame');

let W = 900, H = 650, DPR = 1;

function resizeCanvas(retry = 0) {
  const r = FRAME.getBoundingClientRect();
  if (r.width < 2 || r.height < 2) {
    if (retry < 10) requestAnimationFrame(() => resizeCanvas(retry + 1));
    return;
  }
  DPR = Math.min(2, window.devicePixelRatio || 1);
  W = Math.floor(r.width);
  H = Math.floor(r.height);
  CANVAS.width = Math.max(1, Math.floor(W * DPR));
  CANVAS.height = Math.max(1, Math.floor(H * DPR));
  CTX.setTransform(DPR, 0, 0, DPR, 0, 0);
}
new ResizeObserver(() => resizeCanvas()).observe(FRAME);
window.addEventListener('resize', () => resizeCanvas());
document.addEventListener('fullscreenchange', () => setTimeout(() => resizeCanvas(), 60));
resizeCanvas();

const Input = {
  keys: Object.create(null),
  touch: { up:false, down:false, left:false, right:false, z:false, x:false },
  pressed: { fire:false }, // edge-trigger
  init() {
    const prevent = new Set(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space']);
    window.addEventListener('keydown', (e) => {
      if (prevent.has(e.code)) e.preventDefault();
      if (!this.keys[e.code] && (e.code === 'KeyZ' || e.code === 'Enter')) this.pressed.fire = true;
      this.keys[e.code] = true;
    }, { passive:false });

    window.addEventListener('keyup', (e) => { this.keys[e.code] = false; }, { passive:true });

    const bind = (id, key, fireEdge=false) => {
      const el = document.getElementById(id);
      if (!el) return;
      const down = (e) => { e.preventDefault(); this.touch[key] = true; if (fireEdge) this.pressed.fire = true; };
      const up = (e) => { e.preventDefault(); this.touch[key] = false; };
      el.addEventListener('pointerdown', down, { passive:false });
      el.addEventListener('pointerup', up, { passive:false });
      el.addEventListener('pointercancel', up, { passive:false });
      el.addEventListener('pointerleave', up, { passive:false });
    };

    bind('btn-up','up'); bind('btn-down','down'); bind('btn-left','left'); bind('btn-right','right');
    bind('btn-z','z', true); bind('btn-x','x');

    document.getElementById('dialogue-box').addEventListener('pointerdown', () => this.pressed.fire = true);
  },
  consumeFire() { const v=this.pressed.fire; this.pressed.fire=false; return v; },
  isDown(action) {
    if (action==='up') return this.keys['ArrowUp'] || this.keys['KeyW'] || this.touch.up;
    if (action==='down') return this.keys['ArrowDown'] || this.keys['KeyS'] || this.touch.down;
    if (action==='left') return this.keys['ArrowLeft'] || this.keys['KeyA'] || this.touch.left;
    if (action==='right') return this.keys['ArrowRight'] || this.keys['KeyD'] || this.touch.right;
    if (action==='fire') return this.keys['KeyZ'] || this.keys['Enter'] || this.touch.z;
    if (action==='focus') return this.keys['KeyX'] || this.keys['ShiftLeft'] || this.touch.x;
    return false;
  }
};

const AudioMan = {
  ctx:null, musicTimer:null,
  init(){ if(this.ctx) return; window.AudioContext = window.AudioContext || window.webkitAudioContext; this.ctx = new AudioContext(); },
  resume(){ if(this.ctx && this.ctx.state==='suspended') this.ctx.resume().catch(()=>{}); },
  tone(freq,type,dur,vol=0.1){
    if(!this.ctx) return;
    const t = this.ctx.currentTime;
    const o = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    o.type = type; o.frequency.setValueAtTime(freq, t);
    g.gain.setValueAtTime(Math.max(0.0001, vol), t);
    g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
    o.connect(g); g.connect(this.ctx.destination);
    o.start(); o.stop(t + dur);
  },
  sfx(id){
    if(id==='text') this.tone(750 + Math.random()*250,'sine',0.05,0.02);
    if(id==='shoot') this.tone(320,'triangle',0.08,0.06);
    if(id==='hit') this.tone(90,'sawtooth',0.25,0.22);
    if(id==='graze') this.tone(1200,'sine',0.07,0.03);
    if(id==='phase') this.tone(220,'square',0.2,0.12);
    if(id==='win'){ this.tone(523,'sine',0.25,0.08); this.tone(659,'sine',0.25,0.08); this.tone(784,'sine',0.4,0.08); }
  },
  startSadIntro(){
    this.init(); this.resume();
    const seq = [196,185,174.6,164.8,174.6,146.8,164.8,185]; // melancholic loop
    let i=0;
    this.stopMusic();
    this.musicTimer = setInterval(()=>{
      const f = seq[i]; i=(i+1)%seq.length;
      this.tone(f,'sine',2.2,0.06);
      this.tone(f*0.5,'sine',2.8,0.03);
    }, 800);
  },
  stopMusic(){ if(this.musicTimer){ clearInterval(this.musicTimer); this.musicTimer=null; } }
};

const Cinematic = {
  active:false, phase:0, timer:0,
  start(){
    this.active = true; this.phase = 0; this.timer = 0;
    document.getElementById('intro-screen').classList.add('hidden');
    AudioMan.startSadIntro();
  },
  update(){
    this.timer++;
    if (Input.consumeFire()) { this.active=false; AudioMan.stopMusic(); Game.startScript(); return; }
    if(this.phase===0 && this.timer>150){ this.phase=1; this.timer=0; }
    else if(this.phase===1 && this.timer>200){ this.phase=2; this.timer=0; }
    else if(this.phase===2 && this.timer>220){ this.active=false; AudioMan.stopMusic(); Game.startScript(); }
  },
  draw(ctx){
    ctx.fillStyle="#000"; ctx.fillRect(0,0,W,H);
    const cx=W/2, cy=H/2;
    if(this.phase===0){
      ctx.fillStyle="#0f0"; ctx.font="20px monospace";
      ctx.fillText("> SYSTEM CRITICAL", 50, 50);
      ctx.fillText("> MEMORY: FRAGMENTED", 50, 80);
      ctx.fillStyle="#666"; ctx.fillText("> (PRESS Z TO SKIP)", 50, 110);
      if(Math.random()>0.92){ ctx.fillStyle="#fff"; ctx.fillRect(0, Math.random()*H, W, 4); }
      ctx.fillStyle="#ff3e3e"; ctx.beginPath(); ctx.arc(cx+(Math.random()-0.5)*8, cy, 26, 0, Math.PI*2); ctx.fill();
    } else if(this.phase===1){
      const r = this.timer*4;
      ctx.strokeStyle="#00f3ff"; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.stroke();
      const s = Math.max(0.15, 1 - this.timer/200);
      ctx.fillStyle="#ff3e3e"; ctx.beginPath(); ctx.arc(cx, cy, 26*s, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle="#fff"; ctx.font="30px VT323"; ctx.textAlign="center";
      ctx.fillText("FALLING INTO THE CODE...", cx, cy+110);
    } else {
      ctx.fillStyle="rgba(0,243,255,0.28)"; ctx.font="20px monospace";
      for(let i=0;i<34;i++) ctx.fillText(Math.random()>0.5?"1":"0", Math.random()*W, (this.timer*14 + i*33)%H);
      const a = Math.min(1, this.timer/220);
      ctx.fillStyle=`rgba(255,255,255,${a})`; ctx.fillRect(0,0,W,H);
    }
  }
};

const Game = {
  state:'MENU', tick:0, shake:0,
  player:{ x:0, y:0, hp:25, maxHp:25, mp:0, maxMp:100, inv:0 },
  boss:{ active:false, x:0, y:0, hp:0, max:0, type:'', phase:1, timer:0, name:'' },
  bullets:[],
  sIdx:0,
  waiting:false, textTimer:null, currentStr:"", charPos:0,
  grazeCooldown:0,
  combatHelpTimer:0,

  script: [
    {t:'text', s:'sys', txt:"SYSTEM REBOOT... SUCCESS."},
    {t:'text', s:'sys', txt:"NOTICE: Memory lattice unstable. Rendering emotional space."},
    {t:'text', s:'divija', txt:"Where... am I?"},
    {t:'text', s:'divija', txt:"It feels like a room built out of silence."},
    {t:'text', s:'sys', txt:"TIP: Z to continue. Your input matters here."},
    {t:'text', s:'echo', txt:"You always start strong. Then you hesitate."},
    {t:'text', s:'divija', txt:"Who said that?"},
    {t:'text', s:'echo', txt:"I am the limit you assume before you test the proof."},
    {t:'text', s:'echo', txt:"The 'what if' that subtracts from your courage."},
    {t:'text', s:'divija', txt:"Then I’ll do what I do best."},
    {t:'text', s:'divija', txt:"I’ll try again. Even scared."},
    {t:'combat', boss:'echo', hp:360, name:'ECHO OF DOUBT'},

    {t:'text', s:'divija', txt:"My hands are shaking... but I'm still here."},
    {t:'text', s:'sys', txt:"Fragment recovered: SELF-TRUST (partial)."},
    {t:'text', s:'crowd', txt:"Look at her. She wants it so badly."},
    {t:'text', s:'crowd', txt:"If she fails, it proves we were right."},
    {t:'text', s:'divija', txt:"I don’t exist to satisfy your theory of me."},
    {t:'combat', boss:'crowd', hp:520, name:'THE CROWD'},

    {t:'text', s:'sys', txt:"WARNING: Chronological recursion detected."},
    {t:'text', s:'clock', txt:"Tick. Tock."},
    {t:'text', s:'clock', txt:"How many futures did you cancel with one doubt?"},
    {t:'text', s:'divija', txt:"I can’t edit yesterday."},
    {t:'text', s:'divija', txt:"But I can stop letting it compile my tomorrow."},
    {t:'combat', boss:'clock', hp:650, name:'THE CLOCK'},

    {t:'text', s:'memory', txt:"Divija. Breathe."},
    {t:'text', s:'divija', txt:"Dad?"},
    {t:'text', s:'memory', txt:"You’re not a bug. You’re a person learning."},
    {t:'text', s:'memory', txt:"Come home. I’m proud of you."},
    {t:'win'}
  ],

  hideScreens(){
    document.getElementById('intro-screen').classList.add('hidden');
    document.getElementById('game-over').classList.add('hidden');
    document.getElementById('victory-screen').classList.add('hidden');
  },

  startIntro(){
    this.hideScreens();
    document.getElementById('hud').style.opacity = 0;
    document.getElementById('dialogue-box').style.display = 'none';
    document.getElementById('touch-controls').style.display = '';
    resizeCanvas(); setTimeout(resizeCanvas, 50); // ensures INITIALIZE works even if layout is settling
    this.state = 'INTRO';
    Cinematic.start();
  },

  startScript(){
    this.hideScreens();
    resizeCanvas();
    this.state = 'DIALOGUE';
    this.tick = 0;
    this.bullets = [];
    this.player.x = W/2; this.player.y = H-120;
    this.player.hp = this.player.maxHp; this.player.mp = 0; this.player.inv = 0;
    this.boss.active = false;
    this.sIdx = 0;
    document.getElementById('hud').style.opacity = 1;
    document.getElementById('control-help').classList.remove('show');
    document.getElementById('boss-bar-container').style.display = 'none';
    this.processStep();
  },

  processStep(){
    if(this.sIdx >= this.script.length) return;
    const s = this.script[this.sIdx];

    if(s.t === 'text'){
      this.state = 'DIALOGUE';
      this.showDialogue(s.s, s.txt);
    } else if(s.t === 'combat'){
      this.state = 'COMBAT';
      document.getElementById('dialogue-box').style.display = 'none';
      this.bullets = [];
      this.boss.active = true;
      this.boss.type = s.boss;
      this.boss.name = s.name || s.boss.toUpperCase();
      this.boss.max = s.hp;
      this.boss.hp = s.hp;
      this.boss.phase = 1;
      this.boss.timer = 0;
      this.boss.x = W/2; this.boss.y = 110;
      document.getElementById('boss-name').textContent = this.boss.name;
      document.getElementById('boss-bar-container').style.display = 'block';
      this.combatHelpTimer = 60 * 6; // show reminder strongly for first 6 seconds
    } else if(s.t === 'win'){
      this.state = 'WIN';
      AudioMan.sfx('win');
      document.getElementById('victory-screen').classList.remove('hidden');
      document.getElementById('hud').style.opacity = 0;
      document.getElementById('touch-controls').style.display = 'none';
      document.getElementById('dialogue-box').style.display = 'none';
      document.getElementById('control-help').classList.remove('show');
    }
  },

  showDialogue(speaker, text){
    const box = document.getElementById('dialogue-box');
    box.style.display = 'block';
    document.getElementById('speaker-name').innerText = speaker;
    const txtEl = document.getElementById('dialogue-text');
    txtEl.textContent = "";

    this.drawPortrait(speaker);

    this.currentStr = text;
    this.charPos = 0;
    this.waiting = false;

    clearInterval(this.textTimer);
    this.textTimer = setInterval(() => {
      if(this.charPos >= this.currentStr.length){
        clearInterval(this.textTimer);
        this.waiting = true;
        return;
      }
      txtEl.textContent += this.currentStr[this.charPos++];
      if(this.charPos % 3 === 0) AudioMan.sfx('text');
    }, 28);
  },

  handleInteraction(){
    if(this.state === 'INTRO'){ this.startScript(); return; }
    if(this.state !== 'DIALOGUE') return;

    if(!this.waiting){
      clearInterval(this.textTimer);
      document.getElementById('dialogue-text').textContent = this.currentStr;
      this.waiting = true;
    } else {
      this.sIdx++;
      this.processStep();
    }
  },

  drawPortrait(speaker){
    const ctx = P_CTX;
    ctx.fillStyle = "#111"; ctx.fillRect(0,0,100,100);
    const cx = 50, cy = 50;

    if(speaker === 'divija'){
      ctx.fillStyle = "#ff3e3e"; ctx.beginPath(); ctx.arc(cx, cy, 30, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = "#00f3ff"; ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.fill();
    } else if(speaker === 'sys'){
      ctx.fillStyle = "#00f3ff"; ctx.font = "40px monospace"; ctx.textAlign="center"; ctx.fillText("SYS", cx, cy+10);
    } else if(speaker === 'echo'){
      ctx.fillStyle = "#888"; ctx.fillRect(20, 20, 60, 60);
      ctx.fillStyle = "#333"; ctx.fillRect(32, 32, 36, 36);
    } else if(speaker === 'crowd'){
      ctx.fillStyle = "#f0f";
      for(let i=0;i<3;i++){ ctx.beginPath(); ctx.arc(30+i*20, 55, 10, 0, Math.PI*2); ctx.fill(); }
    } else if(speaker === 'clock'){
      ctx.strokeStyle = "#ffd700"; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.arc(cx, cy, 28, 0, Math.PI*2); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx, cy-16); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+12, cy+6); ctx.stroke();
    } else if(speaker === 'memory'){
      ctx.fillStyle = "#ffd700"; ctx.beginPath(); ctx.arc(cx, cy, 24, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(cx, cy, 8, 0, Math.PI*2); ctx.fill();
    } else {
      ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(cx, cy, 20, 0, Math.PI*2); ctx.fill();
    }
  },

  spawnBossBullets(){
    const b = this.boss;
    const t = b.timer;
    const bx = b.x, by = b.y;

    const phase2 = b.hp < b.max * 0.55;
    const phase3 = b.hp < b.max * 0.25;
    b.phase = phase3 ? 3 : (phase2 ? 2 : 1);

    if (t % 120 === 0 && b.phase > 1) AudioMan.sfx('phase');

    if(b.type === 'echo'){
      // Aimed triple + spiral as difficulty ramps
      if(t % (b.phase===3 ? 10 : 14) === 0){
        const ang = Math.atan2(this.player.y - by, this.player.x - bx);
        const spread = b.phase===1 ? 0.16 : (b.phase===2 ? 0.22 : 0.28);
        for(let i=-1;i<=1;i++){
          const a = ang + i*spread;
          this.bullets.push({x:bx,y:by,vx:Math.cos(a)*5.3,vy:Math.sin(a)*5.3,t:'e',c:'#fff'});
        }
      }
      if(b.phase>=2 && t % 18 === 0){
        const a = t*0.08;
        this.bullets.push({x:bx,y:by,vx:Math.cos(a)*3.7,vy:Math.sin(a)*3.7,t:'e',c:'#aaa'});
      }
    }

    if(b.type === 'crowd'){
      // Ring bursts + occasional “drop” lines
      if(t % (b.phase===3 ? 16 : 22) === 0){
        const n = b.phase===1 ? 10 : (b.phase===2 ? 14 : 18);
        const base = t*0.05;
        for(let i=0;i<n;i++){
          const a = base + i*(Math.PI*2/n);
          this.bullets.push({x:bx,y:by,vx:Math.cos(a)*3.6,vy:Math.sin(a)*3.6,t:'e',c:'#f0f'});
        }
      }
      if(b.phase>=2 && t % 55 === 0){
        for(let x=80; x<W-80; x+=120){
          this.bullets.push({x:x,y:-10,vx:0,vy:4.2+(b.phase*0.5),t:'e',c:'#ffb3ff'});
        }
      }
    }

    if(b.type === 'clock'){
      // Clock = dense rotating spokes + aimed “second hand”
      if(t % (b.phase===3 ? 10 : 14) === 0){
        const n = b.phase===1 ? 10 : (b.phase===2 ? 14 : 18);
        const base = t*0.045;
        const spd = 3.4 + b.phase*0.35;
        for(let i=0;i<n;i++){
          const a = base + i*(Math.PI*2/n);
          this.bullets.push({x:bx,y:by,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,t:'e',c:'#ffd700'});
        }
      }
      if(b.phase>=2 && t % 24 === 0){
        const ang = Math.atan2(this.player.y - by, this.player.x - bx);
        this.bullets.push({x:bx,y:by,vx:Math.cos(ang)*6.2,vy:Math.sin(ang)*6.2,t:'e',c:'#fff'});
      }
    }
  },

  loop(){
    requestAnimationFrame(() => this.loop());
    this.tick++;

    if (Input.consumeFire()) this.handleInteraction();

    CTX.fillStyle = "#050505";
    CTX.fillRect(0,0,W,H);

    let didShake = false;
    if(this.shake > 0){
      didShake = true;
      CTX.save();
      CTX.translate((Math.random()-0.5)*this.shake, (Math.random()-0.5)*this.shake);
      this.shake *= 0.9;
      if(this.shake < 0.5) this.shake = 0;
    }

    if(this.state === 'INTRO'){
      Cinematic.update();
      Cinematic.draw(CTX);
    }

    if(this.state === 'DIALOGUE' || this.state === 'COMBAT'){
      // subtle star noise
      CTX.fillStyle = "rgba(255,255,255,0.15)";
      for(let i=0;i<60;i++){
        const sx = (i*157 + this.tick*0.15) % W;
        const sy = (i*89  + this.tick*0.08) % H;
        CTX.fillRect(sx, sy, 1, 1);
      }

      // combat controls overlay
      const help = document.getElementById('control-help');
      if(this.state === 'COMBAT'){
        help.classList.add('show');
        if(this.combatHelpTimer > 0) this.combatHelpTimer--;
      } else {
        help.classList.remove('show');
      }

      // player movement + shooting
      if(this.state === 'COMBAT'){
        const spd = Input.isDown('focus') ? 2.8 : 5.8;
        if(Input.isDown('left')) this.player.x -= spd;
        if(Input.isDown('right')) this.player.x += spd;
        if(Input.isDown('up')) this.player.y -= spd;
        if(Input.isDown('down')) this.player.y += spd;
        this.player.x = Math.max(20, Math.min(W-20, this.player.x));
        this.player.y = Math.max(20, Math.min(H-20, this.player.y));

        if(Input.isDown('fire') && this.tick % 5 === 0){
          this.bullets.push({x:this.player.x, y:this.player.y, vx:0, vy:-14, t:'p', c:'#ff3e3e'});
          if(Input.isDown('focus')){
            this.bullets.push({x:this.player.x-8, y:this.player.y, vx:-1.4, vy:-12, t:'p', c:'#ff6666'});
            this.bullets.push({x:this.player.x+8, y:this.player.y, vx: 1.4, vy:-12, t:'p', c:'#ff6666'});
          }
          AudioMan.sfx('shoot');
        }

        // boss move + patterns
        if(this.boss.active){
          this.boss.timer++;
          this.boss.x = W/2 + Math.sin(this.tick*0.02)*Math.min(140, W*0.18);
          this.boss.y = 90 + Math.sin(this.tick*0.015)*20;
          this.spawnBossBullets();
        }
      }

      // draw boss
      if(this.state === 'COMBAT' && this.boss.active){
        CTX.fillStyle = this.boss.type==='echo' ? '#aaa' : (this.boss.type==='crowd' ? '#f0f' : '#ffd700');
        CTX.fillRect(this.boss.x-30, this.boss.y-30, 60, 60);

        // boss bar
        const pct = (this.boss.hp / this.boss.max) * 100;
        document.getElementById('boss-bar-fill').style.width = pct + "%";
      }

      // bullets + collisions
      for(let i=this.bullets.length-1;i>=0;i--){
        const b = this.bullets[i];
        b.x += b.vx; b.y += b.vy;

        CTX.fillStyle = b.c;
        CTX.beginPath(); CTX.arc(b.x, b.y, b.t==='p'?4:6, 0, Math.PI*2); CTX.fill();

        if(b.x<-40 || b.x>W+40 || b.y<-40 || b.y>H+40){ this.bullets.splice(i,1); continue; }

        if(b.t === 'e'){
          const d = Math.hypot(b.x - this.player.x, b.y - (this.player.y+10));
          if(d < 10 && this.player.inv === 0){
            this.player.hp--;
            this.player.inv = 65;
            this.shake = Math.max(this.shake, 10);
            AudioMan.sfx('hit');
            this.bullets.splice(i,1);
            if(this.player.hp <= 0){
              this.state = 'OVER';
              document.getElementById('game-over').classList.remove('hidden');
              document.getElementById('touch-controls').style.display = 'none';
              document.getElementById('control-help').classList.remove('show');
            }
          } else if(d < 28 && this.grazeCooldown <= 0){
            this.grazeCooldown = 10;
            this.player.mp = Math.min(this.player.maxMp, this.player.mp + 1);
            AudioMan.sfx('graze');
          }
        }

        if(b.t === 'p' && this.boss.active){
          const d = Math.hypot(b.x - this.boss.x, b.y - this.boss.y);
          if(d < 40){
            this.boss.hp--;
            this.bullets.splice(i,1);
            if(this.boss.hp <= 0){
              this.boss.active = false;
              this.bullets = [];
              document.getElementById('boss-bar-container').style.display = 'none';
              this.sIdx++;
              this.processStep();
            }
          }
        }
      }
      if(this.grazeCooldown > 0) this.grazeCooldown--;

      // draw player (heart)
      if(this.player.inv > 0) this.player.inv--;
      if(!(this.player.inv > 0 && Math.floor(this.tick/4)%2)){
        const x=this.player.x, y=this.player.y;
        CTX.fillStyle="#ff3e3e";
        CTX.beginPath();
        CTX.moveTo(x, y + 5);
        CTX.bezierCurveTo(x, y, x - 10, y - 10, x - 10, y);
        CTX.bezierCurveTo(x - 10, y + 10, x, y + 15, x, y + 20);
        CTX.bezierCurveTo(x, y + 15, x + 10, y + 10, x + 10, y);
        CTX.bezierCurveTo(x + 10, y - 10, x, y, x, y + 5);
        CTX.fill();

        if(Input.isDown('focus')){
          CTX.fillStyle="#00f3ff";
          CTX.beginPath(); CTX.arc(x, y+8, 4, 0, Math.PI*2); CTX.fill();
        }
      }

      // HUD update
      document.getElementById('hp-bar').style.width = ((this.player.hp/this.player.maxHp)*100) + "%";
      document.getElementById('mp-bar').style.width = ((this.player.mp/this.player.maxMp)*100) + "%";
    }

    if(didShake) CTX.restore();
  }
};

Input.init();
Game.loop();

// buttons
document.getElementById('start-btn').onclick = () => {
  AudioMan.init(); AudioMan.resume();
  resizeCanvas(); setTimeout(resizeCanvas, 50);
  Game.startIntro();
};
document.getElementById('retry-btn').onclick = () => Game.startScript();
</script>
</body>
</html>
