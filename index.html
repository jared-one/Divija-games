<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divija: The Calculus of the Heart [Deluxe]</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ù§Ô∏è</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Cinzel:wght@700&family=Press+Start+2P&display=swap');

        :root {
            --bg: #050505;
            --heart: #ff4d4d;
            --soul: #00f3ff;
            --gold: #ffd700;
            --void: #1a1a1a;
            --text-shadow: 2px 2px 0px #000;
        }

        body {
            margin: 0;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'VT323', monospace;
            color: white;
            user-select: none;
        }

        /* --- CRT CONTAINER --- */
        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            background: #000;
            border: 4px solid #333;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.1);
            overflow: hidden;
            border-radius: 10px;
        }

        canvas { display: block; image-rendering: pixelated; }

        /* --- UI LAYERS --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: space-between; padding: 20px; box-sizing: border-box; z-index: 20;
            opacity: 0; transition: opacity 1s;
        }

        .hud-row {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 24px; text-shadow: var(--text-shadow);
        }

        .bar-container {
            width: 200px; height: 20px; background: #333;
            border: 2px solid white; margin-left: 10px; position: relative;
        }
        .bar-fill { height: 100%; transition: width 0.1s linear; }
        #hp-fill { background: var(--heart); }
        #tp-fill { background: var(--soul); width: 0%; }

        /* --- DIALOGUE --- */
        #dialogue-box {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; height: 160px; background: #000; border: 4px solid white;
            padding: 20px; display: none; box-sizing: border-box; font-size: 28px; line-height: 1.2;
            z-index: 30;
        }
        .face-portrait {
            float: left; width: 100px; height: 100px; margin-right: 20px;
            border: 2px solid white; background: #000; display: flex;
            justify-content: center; align-items: center; font-size: 50px;
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,1); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 50;
            transition: opacity 1s;
        }
        .hidden { opacity: 0; pointer-events: none; }

        h1 {
            font-family: 'Cinzel', serif; font-size: 60px; color: var(--soul);
            margin: 0; text-shadow: 0 0 20px var(--soul); letter-spacing: 5px;
        }

        button {
            background: transparent; color: white; font-family: 'VT323', monospace;
            font-size: 30px; border: 2px solid white; padding: 10px 40px; margin-top: 40px;
            cursor: pointer; transition: all 0.2s; text-transform: uppercase;
        }
        button:hover { background: white; color: black; transform: scale(1.1); box-shadow: 0 0 20px white; }

        /* --- CINEMATIC INTRO STYLES --- */
        #cinematic-layer {
            background: #000; z-index: 40; text-align: center;
        }
        .scene-element { font-size: 100px; transition: all 2s; position: absolute; }
        .fade-in { opacity: 1; }
        .fade-out { opacity: 0; }
        
        #story-text {
            position: absolute; bottom: 100px; width: 100%; text-align: center;
            font-size: 32px; color: #ddd; font-family: 'Cinzel', serif;
        }

        /* --- CRT FX --- */
        .scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 6px 100%; pointer-events: none; z-index: 100;
        }
        .flicker { animation: flicker 0.15s infinite; pointer-events: none; opacity: 0.1; position: absolute; width: 100%; height: 100%; background:white; z-index: 99;}
        
        @keyframes flicker { 0% { opacity: 0.02; } 50% { opacity: 0.05; } 100% { opacity: 0.02; } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        .controls { margin-top: 20px; color: #666; font-size: 18px; }
        .key { color: var(--gold); border: 1px solid #555; padding: 0 4px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div class="scanlines"></div>
    <div class="flicker"></div>

    <!-- UI -->
    <div id="ui-layer">
        <div class="hud-row">
            <div style="display:flex; align-items:center;">
                <span style="color:var(--heart)">DIVIJA</span>
                <span style="font-size:18px; color:#888; margin-left:10px;">LV 25</span>
                <div class="bar-container">
                    <div class="bar-fill" id="hp-fill"></div>
                </div>
                <span id="hp-text" style="margin-left:10px">20/20</span>
            </div>
            <div style="display:flex; align-items:center;">
                <span style="color:var(--soul)">BOMB</span>
                <div class="bar-container" style="width:100px; border-color:var(--soul)">
                    <div class="bar-fill" id="tp-fill"></div>
                </div>
                <span id="tp-text" style="margin-left:10px">0%</span>
            </div>
        </div>

        <div id="dialogue-box">
            <div class="face-portrait" id="face-icon">‚ô•</div>
            <div id="dialogue-text"></div>
            <div style="position:absolute; bottom:10px; right:20px; font-size:16px; color:#666;">[Z] NEXT</div>
        </div>
    </div>

    <!-- TITLE SCREEN -->
    <div id="title-screen" class="screen">
        <h1 style="font-size:70px">DIVIJA</h1>
        <div style="font-size:24px; letter-spacing:8px; margin-bottom:20px; color:#888;">CALCULUS OF THE HEART</div>
        <button id="btn-start">BEGIN SIMULATION</button>
        <div class="controls">
            <p>ARROWS to Move ‚Ä¢ SHIFT to Focus</p>
            <p>Z to Shoot/Talk ‚Ä¢ X to Bomb</p>
        </div>
    </div>

    <!-- CINEMATIC LAYER -->
    <div id="cinematic-layer" class="screen hidden">
        <div id="scene-container" style="position:relative; width:100%; height:100%;">
            <!-- Elements injected by JS -->
        </div>
        <div id="story-text"></div>
        <button id="skip-btn" style="position:absolute; bottom:20px; right:20px; font-size:16px; padding:5px 10px; margin:0;">Skip >></button>
    </div>

    <!-- GAME OVER -->
    <div id="game-over" class="screen hidden">
        <h1 style="color: var(--heart)">HEART BROKEN</h1>
        <p style="font-size: 24px;">Divija does not give up.</p>
        <button id="btn-retry">Refuse to Die</button>
    </div>

    <!-- VICTORY -->
    <div id="victory-screen" class="screen hidden">
        <h1 style="color: var(--gold)">PROOF COMPLETE</h1>
        <div style="text-align: center; max-width: 600px; font-size: 24px; line-height: 1.5;">
            <p>The variable 'Divija' has withstood the Chaos.</p>
            <p>You are stronger than the system.</p>
            <p style="margin-top: 30px; color: var(--soul); font-size: 32px;">
                Happy Birthday.<br>Love, Daddy. üëë
            </p>
        </div>
        <button onclick="location.reload()">Reset World</button>
    </div>
</div>

<script>
/**
 * ENGINE: HEART_CORE_V3
 * Advanced Bullet Hell Engine + Cinematic Sequencer
 */

const CONFIG = {
    w: 800, h: 600,
    colors: { bg: '#050505', heart: '#ff4d4d', soul: '#00f3ff', bullet: '#FFF', warn: '#FF0000', gold: '#ffd700' }
};

// --- AUDIO MANAGER ---
const AudioMan = {
    bgm: null,
    ctx: null,
    init() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        // Try to load the MP3
        this.bgm = new Audio('fallen-down.mp3');
        this.bgm.loop = true;
        this.bgm.volume = 0.5;
    },
    playBGM() {
        if(this.bgm) this.bgm.play().catch(e => console.log("Audio play blocked until interaction"));
    },
    stopBGM() {
        if(this.bgm) {
            // Fade out effect
            let vol = 0.5;
            const fade = setInterval(() => {
                vol -= 0.05;
                if(vol <= 0) {
                    this.bgm.pause();
                    this.bgm.currentTime = 0;
                    clearInterval(fade);
                } else {
                    this.bgm.volume = vol;
                }
            }, 100);
        }
    },
    sfx(type) {
        if (!this.ctx) return;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);

        if (type === 'shoot') {
            osc.frequency.setValueAtTime(400, t);
            gain.gain.setValueAtTime(0.05, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
            osc.start(t); osc.stop(t + 0.1);
        } else if (type === 'hit') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.linearRampToValueAtTime(50, t + 0.2);
            gain.gain.setValueAtTime(0.2, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.2);
            osc.start(t); osc.stop(t + 0.2);
        } else if (type === 'graze') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1200, t);
            gain.gain.setValueAtTime(0.05, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
            osc.start(t); osc.stop(t + 0.1);
        } else if (type === 'bomb') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(100, t);
            osc.frequency.linearRampToValueAtTime(1000, t + 1);
            gain.gain.setValueAtTime(0.3, t);
            gain.gain.linearRampToValueAtTime(0, t + 1);
            osc.start(t); osc.stop(t + 1);
        } else if (type === 'text') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(600, t);
            gain.gain.setValueAtTime(0.05, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.03);
            osc.start(t); osc.stop(t + 0.03);
        }
    }
};

// --- INPUT ---
const Input = {
    keys: {},
    init() {
        window.addEventListener('keydown', e => {
            if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
            this.keys[e.key.toLowerCase()] = true; this.keys[e.code] = true;
        });
        window.addEventListener('keyup', e => {
            this.keys[e.key.toLowerCase()] = false; this.keys[e.code] = false;
        });
    },
    isDown(action) {
        if(action === 'up') return this.keys['arrowup'] || this.keys['w'];
        if(action === 'down') return this.keys['arrowdown'] || this.keys['s'];
        if(action === 'left') return this.keys['arrowleft'] || this.keys['a'];
        if(action === 'right') return this.keys['arrowright'] || this.keys['d'];
        if(action === 'focus') return this.keys['shift'] || this.keys['shiftleft'];
        if(action === 'fire') return this.keys['z'] || this.keys['enter'];
        if(action === 'bomb') return this.keys['x'];
        return false;
    }
};

// --- CINEMATIC ENGINE ---
const Cinematic = {
    step: 0,
    container: document.getElementById('scene-container'),
    text: document.getElementById('story-text'),
    timer: null,
    
    start(onComplete) {
        const layer = document.getElementById('cinematic-layer');
        layer.classList.remove('hidden');
        this.step = 0;
        this.onComplete = onComplete;
        
        // Skip button
        document.getElementById('skip-btn').onclick = () => {
            clearTimeout(this.timer);
            this.end();
        };

        this.playScene();
    },

    playScene() {
        this.container.innerHTML = ''; // Clear previous
        
        const sequences = [
            {
                // Scene 1: Home
                duration: 4000,
                html: `<div class="scene-element" style="top:40%; left:45%; font-size:150px;">üè†</div>
                       <div class="scene-element" style="top:20%; left:20%; animation:float 3s infinite;">üåßÔ∏è</div>
                       <div class="scene-element" style="top:25%; left:70%; animation:float 4s infinite;">üåßÔ∏è</div>`,
                text: "It was a quiet Tuesday..."
            },
            {
                // Scene 2: Forest
                duration: 4000,
                html: `<div class="scene-element" style="top:40%; left:20%; font-size:120px;">üå≤</div>
                       <div class="scene-element" style="top:35%; left:60%; font-size:140px;">üå≤</div>
                       <div class="scene-element" style="top:50%; left:40%; font-size:50px;">üßç‚Äç‚ôÄÔ∏è</div>`,
                text: "You wandered where the code breaks."
            },
            {
                // Scene 3: Glitch
                duration: 4000,
                html: `<div class="scene-element" style="top:40%; left:45%; font-size:150px; color:cyan; text-shadow:2px 2px red;">üëÅÔ∏è</div>
                       <div class="scene-element" style="top:50%; left:40%; font-size:50px; opacity:0.5;">üßç‚Äç‚ôÄÔ∏è</div>`,
                text: "The System found you."
            }
        ];

        if (this.step < sequences.length) {
            const seq = sequences[this.step];
            this.container.innerHTML = seq.html;
            this.text.innerText = seq.text;
            this.text.style.opacity = 0;
            
            // Fade text in
            setTimeout(() => this.text.style.opacity = 1, 500);

            this.timer = setTimeout(() => {
                this.step++;
                this.playScene();
            }, seq.duration);
        } else {
            this.end();
        }
    },

    end() {
        document.getElementById('cinematic-layer').classList.add('hidden');
        AudioMan.stopBGM(); // Stop the sad song
        if(this.onComplete) this.onComplete();
    }
};

// --- GAME ENTITIES ---
class Player {
    constructor() {
        this.x = CONFIG.w / 2; this.y = CONFIG.h - 100;
        this.r = 3; // Soul Hitbox
        this.spriteR = 12; // Visual
        this.speed = 5; this.focusSpeed = 2;
        this.hp = 20; this.maxHp = 20;
        this.tp = 0; // Tech Points (Bomb meter)
        this.invuln = 0;
    }

    update(arena) {
        const spd = Input.isDown('focus') ? this.focusSpeed : this.speed;
        if (Input.isDown('left')) this.x -= spd;
        if (Input.isDown('right')) this.x += spd;
        if (Input.isDown('up')) this.y -= spd;
        if (Input.isDown('down')) this.y += spd;

        // Clamp
        this.x = Math.max(arena.x + 8, Math.min(arena.x + arena.w - 8, this.x));
        this.y = Math.max(arena.y + 8, Math.min(arena.y + arena.h - 8, this.y));

        if (this.invuln > 0) this.invuln--;

        // Shoot
        if (Input.isDown('fire') && Game.tick % 5 === 0) {
            Game.bullets.push(new Bullet(this.x - 5, this.y - 10, -Math.PI/2, 12, 'player'));
            Game.bullets.push(new Bullet(this.x + 5, this.y - 10, -Math.PI/2, 12, 'player'));
            AudioMan.sfx('shoot');
        }

        // Bomb
        if (Input.isDown('bomb') && this.tp >= 100) {
            this.tp = 0;
            Game.clearEnemyBullets();
            Game.particles.push(new Effect(this.x, this.y, 'nova'));
            AudioMan.sfx('bomb');
            Game.shake = 20;
        }
    }

    draw(ctx) {
        if (this.invuln > 0 && Math.floor(Date.now()/50)%2) return;
        
        // Draw Heart
        ctx.fillStyle = CONFIG.colors.heart;
        ctx.beginPath();
        const y = this.y; const x = this.x; const r = this.spriteR;
        ctx.moveTo(x, y + r/2);
        ctx.bezierCurveTo(x, y, x - r, y - r, x - r, y);
        ctx.bezierCurveTo(x - r, y + r, x, y + r*1.5, x, y + r*2);
        ctx.bezierCurveTo(x, y + r*1.5, x + r, y + r, x + r, y);
        ctx.bezierCurveTo(x + r, y - r, x, y - r, x, y + r/2);
        ctx.fill();

        if (Input.isDown('focus')) {
            ctx.fillStyle = CONFIG.colors.soul;
            ctx.beginPath(); ctx.arc(this.x, this.y + r, this.r, 0, Math.PI*2); ctx.fill();
        }
    }
}

class Bullet {
    constructor(x, y, angle, speed, type, color) {
        this.x = x; this.y = y;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.type = type; // 'player', 'enemy'
        this.color = color || '#FFF';
        this.active = true;
        this.grazed = false;
        this.timer = 0;
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        this.timer++;
        // Bounds
        if(this.x<-50 || this.x>CONFIG.w+50 || this.y<-50 || this.y>CONFIG.h+50) this.active = false;
    }
    draw(ctx) {
        ctx.fillStyle = this.color;
        ctx.beginPath();
        if(this.type === 'player') {
            ctx.rect(this.x-2, this.y-5, 4, 10);
        } else {
            ctx.arc(this.x, this.y, 5, 0, Math.PI*2);
        }
        ctx.fill();
    }
}

class Effect {
    constructor(x, y, type) {
        this.x = x; this.y = y;
        this.type = type;
        this.life = 30; this.maxLife = 30;
        this.vx = (Math.random()-0.5)*4; this.vy = (Math.random()-0.5)*4;
    }
    update() { this.x+=this.vx; this.y+=this.vy; this.life--; }
    draw(ctx) {
        ctx.globalAlpha = this.life / this.maxLife;
        if(this.type==='nova') {
            ctx.strokeStyle = CONFIG.colors.soul;
            ctx.lineWidth = 3;
            ctx.beginPath(); ctx.arc(this.x, this.y, (30-this.life)*15, 0, Math.PI*2); ctx.stroke();
        } else {
            ctx.fillStyle = this.type==='hit' ? CONFIG.colors.heart : CONFIG.colors.soul;
            ctx.fillRect(this.x, this.y, 4, 4);
        }
        ctx.globalAlpha = 1;
    }
}

// --- GAME LOGIC ---
const Game = {
    canvas: document.getElementById('gameCanvas'),
    ctx: null,
    tick: 0,
    state: 'MENU', // MENU, INTRO, DIALOGUE, COMBAT, GAMEOVER, WIN
    
    player: null,
    bullets: [],
    particles: [],
    arena: { x: 0, y: 0, w: 0, h: 0, targetW: 0, targetH: 0 },
    shake: 0,
    
    // Script & Flow
    scriptIndex: 0,
    bossHp: 100,
    maxBossHp: 100,
    pattern: null,
    patternTimer: 0,
    
    script: [
        { t: 'text', f: 'sys', txt: "IDENTITY CONFIRMED: DIVIJA." },
        { t: 'text', f: 'sys', txt: "VARIABLES: Stubbornness > 99%. Logic < Undefined." },
        { t: 'text', f: 'heart', txt: "Where am I? Why is it so quiet?" },
        { t: 'text', f: 'sys', txt: "You are in the Compiler. I am debugging your path." },
        { t: 'text', f: 'sys', txt: "Survival requires precision. Let us begin." },
        
        // PHASE 1: RAIN
        { t: 'fight', p: 'rain', d: 500, txt: "PHASE 1: THE RAIN" },
        
        { t: 'text', f: 'sys', txt: "You dodge the obvious. But can you dodge the confusion?" },
        { t: 'text', f: 'heart', txt: "I'm not confused. I'm just getting started." },

        // PHASE 2: SINE
        { t: 'fight', p: 'sine', d: 600, txt: "PHASE 2: THE FREQUENCY" },

        { t: 'text', f: 'sys', txt: "Your heart rate is elevating. Good." },
        { t: 'text', f: 'heart', txt: "Stop analyzing me! I'm not a math problem." },
        { t: 'text', f: 'sys', txt: "Everything is a math problem. Even love." },

        // PHASE 3: FLOWER (Rotational)
        { t: 'fight', p: 'flower', d: 700, txt: "PHASE 3: THE BLOSSOM" },

        { t: 'text', f: 'heart', txt: "Hah... Hah... Is that it?" },
        { t: 'text', f: 'sys', txt: "You are resilient. Daddy taught you well." },
        { t: 'text', f: 'heart', txt: "Don't bring him into this!" },
        { t: 'text', f: 'sys', txt: "He is the constant in your equation. But now, you must stand alone." },

        // PHASE 4: FINAL (Chaos)
        { t: 'fight', p: 'chaos', d: 900, txt: "FINAL PHASE: THE CALCULUS" },
        
        { t: 'win' }
    ],

    init() {
        this.ctx = this.canvas.getContext('2d');
        this.canvas.width = CONFIG.w; this.canvas.height = CONFIG.h;
        Input.init();
        
        const loop = () => {
            this.update();
            this.draw();
            requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
    },

    start() {
        this.player = new Player();
        this.bullets = [];
        this.particles = [];
        this.scriptIndex = 0;
        this.arena = { x: 300, y: 350, w: 200, h: 150, targetW: 200, targetH: 150 };
        
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('game-over').classList.add('hidden');
        
        AudioMan.playBGM();
        Cinematic.start(() => {
            document.getElementById('ui-layer').style.opacity = 1;
            this.nextScript();
        });
    },

    nextScript() {
        if (this.scriptIndex >= this.script.length) return;
        const s = this.script[this.scriptIndex];
        this.scriptIndex++;

        if (s.t === 'text') {
            this.state = 'DIALOGUE';
            this.arena.targetW = CONFIG.w - 100;
            this.arena.targetH = 150;
            this.showDialogue(s.txt, s.f);
        } else if (s.t === 'fight') {
            this.state = 'COMBAT';
            this.pattern = s.p;
            this.patternTimer = s.d;
            this.arena.targetW = 500;
            this.arena.targetH = 450;
            document.getElementById('dialogue-box').style.display = 'none';
        } else if (s.t === 'win') {
            this.state = 'WIN';
            document.getElementById('victory-screen').classList.remove('hidden');
        }
    },

    showDialogue(text, face) {
        const box = document.getElementById('dialogue-box');
        const icon = document.getElementById('face-icon');
        box.style.display = 'block';
        icon.innerText = face === 'heart' ? '‚ô•' : '‚ö°';
        icon.style.color = face === 'heart' ? CONFIG.colors.heart : CONFIG.colors.soul;
        
        // Typewriter
        let i = 0;
        const el = document.getElementById('dialogue-text');
        el.innerText = "";
        this.inputLocked = true;
        
        const timer = setInterval(() => {
            el.innerText += text.charAt(i);
            i++;
            if (i % 2 === 0) AudioMan.sfx('text');
            if (i >= text.length) {
                clearInterval(timer);
                this.inputLocked = false;
            }
        }, 30);
    },

    update() {
        this.tick++;
        
        // Arena Lerp
        const ease = 0.08;
        this.arena.x = (CONFIG.w - this.arena.w) / 2;
        this.arena.y = (CONFIG.h - this.arena.h) / 2 + (this.state === 'DIALOGUE' ? 200 : 0);
        this.arena.w += (this.arena.targetW - this.arena.w) * ease;
        this.arena.h += (this.arena.targetH - this.arena.h) * ease;

        if (this.shake > 0) { this.shake *= 0.9; if(this.shake < 0.5) this.shake = 0; }

        if (this.state === 'DIALOGUE') {
            this.player.update(this.arena);
            if (Input.isDown('fire') && !this.inputLocked && this.tick % 10 === 0) {
                this.nextScript();
            }
        } else if (this.state === 'COMBAT') {
            this.player.update(this.arena);
            this.patternTimer--;
            
            this.handleSpawner();
            this.updateBullets();

            // Progress Bar (Time based for survival)
            if (this.patternTimer <= 0) {
                this.bullets.forEach(b => b.active = false); // Clear
                this.nextScript();
            }
        }

        this.particles.forEach((p,i) => {
            p.update();
            if(p.life<=0) this.particles.splice(i,1);
        });

        // UI Updates
        document.getElementById('hp-fill').style.width = (this.player.hp/this.player.maxHp*100) + '%';
        document.getElementById('hp-text').innerText = this.player.hp;
        document.getElementById('tp-fill').style.width = this.player.tp + '%';
        document.getElementById('tp-text').innerText = Math.floor(this.player.tp) + '%';
    },

    handleSpawner() {
        const t = this.tick;
        const cx = CONFIG.w/2;
        const cy = this.arena.y + this.arena.h/2 - 100;

        // Difficulty curves
        if (this.pattern === 'rain') {
            if (t % 8 === 0) {
                const x = this.arena.x + Math.random() * this.arena.w;
                this.bullets.push(new Bullet(x, 0, Math.PI/2, 4 + Math.random()*2, 'enemy', '#0ff'));
            }
        } else if (this.pattern === 'sine') {
            if (t % 15 === 0) {
                const b = new Bullet(cx, 100, Math.PI/2, 3, 'enemy', '#ff0');
                b.vx = Math.cos(t/20) * 2;
                this.bullets.push(b);
            }
            if (t % 60 === 0) {
                // Aimed Shot
                const angle = Math.atan2(this.player.y - 100, this.player.x - cx);
                this.bullets.push(new Bullet(cx, 100, angle, 6, 'enemy', '#f00'));
            }
        } else if (this.pattern === 'flower') {
            if (t % 15 === 0) {
                const petals = 6;
                const offset = t * 0.1;
                for (let i = 0; i < petals; i++) {
                    const angle = (i / petals) * Math.PI * 2 + offset;
                    this.bullets.push(new Bullet(cx, 150, angle, 3, 'enemy', '#f0f'));
                }
            }
        } else if (this.pattern === 'chaos') {
            // Spiral + Aimed
            if (t % 4 === 0) {
                const angle = t * 0.2;
                this.bullets.push(new Bullet(cx, 150, angle, 4, 'enemy', '#fff'));
                this.bullets.push(new Bullet(cx, 150, angle + Math.PI, 4, 'enemy', '#fff'));
            }
            if (t % 50 === 0) {
                const angle = Math.atan2(this.player.y - 150, this.player.x - cx);
                for(let i=-1; i<=1; i++) {
                    this.bullets.push(new Bullet(cx, 150, angle + i*0.2, 5, 'enemy', '#f00'));
                }
            }
        }
    },

    updateBullets() {
        for (let i = this.bullets.length - 1; i >= 0; i--) {
            const b = this.bullets[i];
            b.update();
            
            if (!b.active) { this.bullets.splice(i, 1); continue; }
            if (b.type === 'player') continue; // Enemy collision handled elsewhere if we had enemies

            const dx = b.x - this.player.x;
            const dy = b.y - (this.player.y + this.player.spriteR); // Offset for heart center
            const dist = Math.sqrt(dx*dx + dy*dy);

            // Graze
            if (dist < 35 && !b.grazed && b.type === 'enemy') {
                b.grazed = true;
                this.player.tp = Math.min(100, this.player.tp + 2); // Charge Bomb
                this.particles.push(new Effect(b.x, b.y, 'graze'));
                AudioMan.sfx('graze');
            }

            // Hit
            if (dist < this.player.r + 5 && b.type === 'enemy') {
                if (this.player.invuln === 0) {
                    this.player.hp -= 2; // Damage
                    this.player.invuln = 50;
                    this.shake = 15;
                    this.particles.push(new Effect(this.player.x, this.player.y, 'hit'));
                    AudioMan.sfx('hit');
                    b.active = false;
                    
                    if (this.player.hp <= 0) {
                        this.state = 'GAMEOVER';
                        document.getElementById('game-over').classList.remove('hidden');
                    }
                }
            }
        }
    },

    clearEnemyBullets() {
        this.bullets.forEach(b => {
            if(b.type === 'enemy') {
                b.active = false;
                this.particles.push(new Effect(b.x, b.y, 'graze'));
            }
        });
    },

    draw() {
        this.ctx.fillStyle = CONFIG.colors.bg;
        this.ctx.fillRect(0, 0, CONFIG.w, CONFIG.h);

        this.ctx.save();
        // Screen Shake
        if (this.shake > 0) {
            this.ctx.translate((Math.random()-0.5)*this.shake, (Math.random()-0.5)*this.shake);
        }

        // Arena Outline
        this.ctx.strokeStyle = '#FFF'; this.ctx.lineWidth = 4;
        this.ctx.strokeRect(this.arena.x, this.arena.y, this.arena.w, this.arena.h);

        // Clip Content to Arena
        this.ctx.save();
        this.ctx.beginPath();
        this.ctx.rect(this.arena.x, this.arena.y, this.arena.w, this.arena.h);
        this.ctx.clip();

        // Grid Background (Moving)
        this.ctx.strokeStyle = 'rgba(255,255,255,0.1)'; this.ctx.lineWidth = 1;
        const off = (this.tick / 2) % 40;
        for(let i=0; i<CONFIG.w; i+=40) {
            this.ctx.beginPath(); this.ctx.moveTo(i, 0); this.ctx.lineTo(i, CONFIG.h); this.ctx.stroke();
            this.ctx.beginPath(); this.ctx.moveTo(0, i + off); this.ctx.lineTo(CONFIG.w, i + off); this.ctx.stroke();
        }

        if(this.player) this.player.draw(this.ctx);
        this.ctx.restore(); // End Clip

        // Bullets drawn ABOVE clip (visual style choice, looks more 3D)
        this.bullets.forEach(b => b.draw(this.ctx));
        this.particles.forEach(p => p.draw(this.ctx));
        
        // The Eye (System Boss)
        if (this.state === 'COMBAT') {
            const cx = CONFIG.w/2; const cy = this.arena.y - 50;
            this.ctx.fillStyle = '#000'; this.ctx.strokeStyle = CONFIG.colors.soul;
            this.ctx.lineWidth = 3;
            this.ctx.beginPath(); this.ctx.arc(cx, cy, 40, 0, Math.PI*2); this.ctx.fill(); this.ctx.stroke();
            this.ctx.fillStyle = CONFIG.colors.soul;
            this.ctx.beginPath(); this.ctx.arc(cx, cy, 15, 0, Math.PI*2); this.ctx.fill();
        }
        
        this.ctx.restore(); // End Shake
    }
};

// --- EVENTS ---
document.getElementById('btn-start').addEventListener('click', () => {
    AudioMan.init();
    Game.init();
    Game.start();
});

document.getElementById('btn-retry').addEventListener('click', () => {
    Game.start();
});

</script>
</body>
</html>
